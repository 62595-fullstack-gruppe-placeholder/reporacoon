name: Lighthouse Audit
on: [pull_request]

permissions:
  contents: read
  pull-requests: write

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./reporaccoonfrontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install and build
        run: |
          npm ci
          npm run build

      - name: Start server and run Lighthouse
        id: run_lighthouse
        run: |
          # Start server in background
          PORT=3001 npm start &
          SERVER_PID=$!
          
          # Wait for server
          sleep 10
          
          # Install Lighthouse
          npm install -g lighthouse
          
          # Run Lighthouse with public storage
          npx lighthouse http://localhost:3001 \
            --output=html \
            --output-path=./lighthouse-report.html \
            --chrome-flags="--headless --no-sandbox"
          
          # Kill server
          kill $SERVER_PID 2>/dev/null || true
          
          # Generate a simple report link
          TIMESTAMP=$(date +%s)
          echo "report_url=https://googlechrome.github.io/lighthouse/viewer/?gist=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "Lighthouse audit completed"

      - name: Upload Lighthouse report
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-report
          path: ./lighthouse-report.html

      - name: Post comment with report link
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            **Lighthouse audit completed**
            
            [View Lighthouse Report](https://googlechrome.github.io/lighthouse/viewer/)
            
            *Download the attached `lighthouse-report.html` artifact to view the full report.*